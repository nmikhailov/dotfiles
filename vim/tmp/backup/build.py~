#!/usr/bin/env python
from os import system, listdir


build_str = 'javac -cp libs/lwjgl.jar:minecraft.jar -d bin/{} sources/{}.java'
path_str = 'mkdir -p "bin/{}"'
tweak_str = "javacnch -s '{0}' 'bin/{1}'"
backup_str = 'cp minecraft.jar minecraft_bak.jar'
zip_str = 'cd bin && zip -r ../minecraft.jar *'
clear_str = 'rm -rf bin && mkdir bin'

print('Creating backup...')
system(backup_str)

print('Cleaning...')
system(clear_str)

system('rm -rf binary/*')
data = open('list').readlines()
for line in data:
    line = line.strip()
    if line[0] == '#':
        continue

    class_name, package = line.split()
    package = package.replace('.', '/')
    if package[-1] != '/':
        package += '/'
    print('Processing class {} package {}'.format(class_name, package))

    print('Creating structure...')
    system(path_str.format(package))

    print('Building...')
    system(build_str.format(package, class_name))

    files = listdir('bin/' + package)
    for f in files:
        p = package
        print('Changing package for {}...'.format(f))
        if '$' in f:
            p = p + class_name + "/"
            system("mv 'bin/{}' 'bin/.'".format(package + f))
            continue
        #else:
        #   system("cp 'bin/{}' 'bin/.'".format(package + f))

        s = tweak_str.format(p + f[:-6], package + f)
        system(s)

print('Updating minecraft...')
system(zip_str.format(package + class_name))

print('Done')
