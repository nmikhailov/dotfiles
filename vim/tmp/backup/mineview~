#!/usr/bin/env python

import socket
import sys
import argparse


def retrive(host):
    port = 25565
    pos = host.find(':')
    if pos != -1:
        port = int(host[pos + 1:])
        host = host[:pos]

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    data, sk = bytearray(), bytearray()
    data.append(0xFE)
    sk.append(0xA7)
    s.send(data)

    res = s.recv(1024)[4:]

    s.close()
    res = map(lambda x: x.decode('utf-8').replace(chr(0x00), ''), res.split(sk))
    return list(res)


def main():
    parser = argparse.ArgumentParser(prog='mineview')
    parser.add_argument('IP', help='Minecraft server address')
    parser.add_argument('-t', metavar='TEMPLATE', default='%n, %p/%t',
            help='''Custom template %%n - server name,
            %%p - players on server,
            %%t - total players''')
    args = parser.parse_args()

    data = None
    try:
        data = retrive(args.IP)
    except Exception:
        sys.stderr.write("Error. Can't connect to server.\n")
        sys.exit(1)

    template = args.t.replace('%%', chr(0x01))

    tags = ['n', 'p', 't']
    for tag, val in zip(tags, data):
        template = template.replace('%' + tag, val)

    template = template.replace(chr(0x01), '%')
    sys.stdout.write(template + '\n')


if __name__ == '__main__':
    main()
