#!/usr/bin/env python2

import socket
import sys
import argparse


def retrive(host):
    port = 25565
    pos = host.find(':')
    if pos != -1:
        port = int(host[pos + 1:])
        host = host[:pos]

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    s.send(chr(0xfe))
    data = s.recv(1024)[1:]
    s.close()
    return data.split(chr(0xa7))


def main():
    parser = argparse.ArgumentParser(prog='mineview')
    parser.add_argument('IP', help='Minecraft server address')
    parser.add_argument('-t', '--template', metavar='TEMPLATE', default='%n, %p/%t',
            help=r'Custom template %n - server name, %p - players on server, %t - total players')
    args = parser.parse_args()

    data = None
    try:
        data = retrive(args.IP)
    except Exception:
        sys.stderr.write("Error. Can't connect to server.\n")
        sys.exit(1)

    template = args.template.replace('%%', chr(0x01))
    template = template.replace('%n', data[0]).replace('%p', data[1]).replace('%t', data[2])
    template = template.replace(chr(0x01), '%')
    sys.stdout.write(template + '\n')


if __name__ == '__main__':
    main()
